# HAProxy Configuration - Managed by Ansible
# VeriAction GeoIP Service Load Balancer

global
    log 127.0.0.1:514 local2
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # SSL/TLS settings
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Performance tuning
    maxconn {{ haproxy_maxconn | default('50000') }}
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch
    retries 3
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Statistics page
listen stats
    bind {{ haproxy_vip }}:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node
    stats auth {{ haproxy_stats_user | default('admin') }}:{{ haproxy_stats_password | default('admin') }}

# Frontend for HTTPS traffic (gRPC and HTTP)
frontend https_frontend
    bind {{ haproxy_vip }}:443 ssl crt /etc/haproxy/certs/haproxy.pem alpn h2,http/1.1
    mode http
    option forwardfor

    # HSTS header for security
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Detect gRPC traffic (Content-Type: application/grpc)
    acl is_grpc hdr(content-type) -m beg application/grpc
    acl is_grpc_web hdr(content-type) -m beg application/grpc-web

    # Route based on content type
    use_backend grpc_geoip_backend if is_grpc or is_grpc_web
    default_backend http_geoip_backend

# Frontend for HTTP traffic (redirect to HTTPS)
frontend http_frontend
    bind {{ haproxy_vip }}:80
    mode http
    redirect scheme https code 301 if !{ ssl_fc }

# Backend for gRPC GeoIP service
backend grpc_geoip_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    # gRPC-specific settings
    timeout connect 5s
    timeout server 60s
    timeout client 60s

{% for host in groups['geoip_servers'] %}
    server {{ host }} {{ hostvars[host].ansible_default_ipv4.address }}:50051 check inter 5s fall 3 rise 2 ssl verify none alpn h2
{% endfor %}

# Backend for HTTP GeoIP service (admin/health endpoints)
backend http_geoip_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    # HTTP settings
    timeout connect 5s
    timeout server 30s
    timeout client 30s

{% for host in groups['geoip_servers'] %}
    server {{ host }}-http {{ hostvars[host].ansible_default_ipv4.address }}:8080 check inter 5s fall 3 rise 2
{% endfor %}

# Backend for Kubernetes API (if needed)
{% if groups['kubernetes_masters'] is defined %}
backend kubernetes_api_backend
    mode tcp
    balance roundrobin
    option tcp-check

{% for host in groups['kubernetes_masters'] %}
    server {{ host }} {{ hostvars[host].ansible_default_ipv4.address }}:6443 check inter 5s fall 3 rise 2
{% endfor %}
{% endif %}
